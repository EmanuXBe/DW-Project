<div class="game-container" id="game-container">
    <header class="game-header">
        <h1 id="game-title">üèÅ Regata Online</h1>

        @if (gameStarted() && !gameOver()) {
        <section class="game-info" id="game-info">
            <div class="info-item" id="game-info-ship"><strong>Barco:</strong> {{ ship().name }}</div>
            <div class="info-item" id="game-info-turn"><strong>Turno:</strong> {{ ship().turnCount }}</div>
            <div class="info-item" id="game-info-velocity"><strong>Velocidad:</strong> v = ({{ ship().vx }}, {{
                ship().vy }})</div>
            <div class="info-item" id="game-info-position"><strong>Posici√≥n:</strong> ({{ ship().posX }}, {{ ship().posY
                }})</div>
        </section>
        }

        @if (gameOver()) {
        <section class="game-over card" id="game-over-section">
            <h2 id="game-over-title">üéâ ¬°Juego Terminado!</h2>
            <p id="game-over-message">Completaste la carrera en <strong id="game-over-turns">{{ ship().turnCount
                    }}</strong> turnos.</p>
            <button class="btn-primary" (click)="router.navigate(['/ships'])" id="game-over-btn-back">
                Volver a Barcos
            </button>
        </section>
        }
    </header>

    @if (gameStarted() && !gameOver() && possibleMoves()) {
    <main class="game-layout">
        <!-- TABLERO -->
        <section class="board-section card" id="game-board-section">
            <div class="game-board" id="game-board">
                @for (row of grid(); track $index) {
                <div class="board-row">
                    @for (cell of row; track cell.id) {
                    <div class="cell" [class]="getCellClass(cell, cell.x!, cell.y!)"
                        [attr.id]="'game-cell-' + cell.x + '-' + cell.y" (click)="onCellClick(cell, cell.x!, cell.y!)"
                        [title]="cell.type || ''">
                        {{ getCellContent(cell, cell.x!, cell.y!) }}
                    </div>
                    }
                </div>
                }
            </div>
        </section>

        <!-- CONTROLES -->
        <aside class="controls-section" id="game-controls">
            <div class="card">
                <section class="move-options" id="game-move-options">
                    <h4 id="game-move-title">üß≠ Opciones de Movimiento</h4>
                    <div class="move-buttons" id="game-move-buttons">
                        @for (position of possibleMoves()!.possiblePositions; track $index) {
                        <button class="btn-move" [class.btn-move-valid]="position.valid"
                            [class.btn-move-invalid]="!position.valid"
                            [class.btn-move-selected]="selectedMove()?.deltaVx === position.deltaVx && selectedMove()?.deltaVy === position.deltaVy"
                            [attr.id]="'game-move-btn-' + position.deltaVx + '-' + position.deltaVy"
                            [disabled]="!position.valid" (click)="selectMove(position)">
                            <div class="move-label">
                                @if (position.deltaVx === 0 && position.deltaVy === 0) {
                                ‚è∏Ô∏è Mantener
                                } @else if (position.deltaVx === 1 && position.deltaVy === 0) {
                                ‚û°Ô∏è +vx
                                } @else if (position.deltaVx === 0 && position.deltaVy === 1) {
                                ‚¨ÜÔ∏è +vy
                                } @else if (position.deltaVx === -1 && position.deltaVy === 0) {
                                ‚¨ÖÔ∏è -vx
                                } @else if (position.deltaVx === 0 && position.deltaVy === -1) {
                                ‚¨áÔ∏è -vy
                                }
                            </div>
                            <div class="move-details">v: ({{ position.vx }}, {{ position.vy }})</div>
                            <div class="move-position">pos: ({{ position.x }}, {{ position.y }})</div>
                            @if (!position.valid) {
                            <div class="move-error">‚ùå {{ position.invalidReason }}</div>
                            }
                        </button>
                        }
                    </div>

                    @if (selectedMove()) {
                    <button class="btn-execute" (click)="executeMove()" id="game-btn-execute">‚úÖ Confirmar
                        Jugada</button>
                    } @else {
                    <p class="hint" id="game-hint">üëÜ Selecciona una opci√≥n</p>
                    }

                    <button class="btn-restart" (click)="restartGame()" id="game-btn-restart">üîÑ Reiniciar</button>
                </section>

                <section class="legend">
                    <h4>üìã Leyenda</h4>
                    <ul class="legend-list">
                        <li><span class="legend-icon">üö¢</span> Barco</li>
                        <li><span class="legend-icon">üèÅ</span> Inicio</li>
                        <li><span class="legend-icon">üèÜ</span> Meta</li>
                        <li><span class="legend-icon">üß±</span> Muro</li>
                        <li><span class="legend-icon">üåä</span> Agua</li>
                    </ul>
                </section>
            </div>
        </aside>
    </main>
    } @else if (gameStarted() && !gameOver()) {
    <div class="board-section-centered">
        <table class="board-grid">
            @for (row of grid(); track $index) {
            <tr>
                @for (cell of row; track cell.id) {
                <td [class]="getCellClass(cell, cell.x!, cell.y!)" (click)="onCellClick(cell, cell.x!, cell.y!)"
                    [title]="cell.type || ''">
                    <span class="cell-content">{{ getCellContent(cell, cell.x!, cell.y!) }}</span>
                </td>
                }
            </tr>
            }
        </table>
    </div>
    } @else {
    <div class="board-section-centered">
        <p>Cargando juego...</p>
    </div>
    }
</div>